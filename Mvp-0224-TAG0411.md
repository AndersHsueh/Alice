# MVP 节点记录 — TAG0411
**记录日期**: 2026-02-24  
**项目**: Alice — AI辅助办公本地代理系统  
**GitHub**: https://github.com/AndersHsueh/Alice.git  
**版本**: v0.4.0

---

## 背景：产品定位（这次会话确认的）

Alice **不是通用助手**，是一个面向项目型团队的**技术型软件系统项目经理**，能自主处理办公室文档类工作。

核心定义：**加速逻辑推理核心执行器** — 提供AI操作本地文件的基础能力，没有这个基础，上层Agent只是搜索引擎。

### 三层架构
```
Alice Core  ←→  Daemon（心跳/巡视）  ←→  Diana（通知/消息通道）
```

- **Alice Core**：CLI主体，文件操作+推理+工具调用
- **Daemon (Veronica)**：后台守护，心跳机制，巡视Obsidian Vault，摄取IM记录，生成待办/提醒
- **Diana**：移动端/通知通道代理，推送提醒，"递小纸条"，收发即时通讯

### 强依赖关系
- **Obsidian Vault** = 单一真相来源（所有中间过程文档、数据汇总、日报均存入此处）
- **Git私服** = 团队协作同步（Vault通过Git同步）
- **钉钉/飞书** = 主要即时通讯（中日两地企业均用钉钉，国际平台在中国企业推广不了）

---

## 产品核心场景：三套办公流程

这是开发者（Anders）在实际工作中实践出的PM工作流，经过半年以上验证：

### 1. 项目实施中期（已验证跑了半年+）
数据来源：
- 飞书群日报（团队成员每日发贴）→ Seed-2.0汇总 → Obsidian积累
- 项目计划表 Excel
- 测试组 Bug表 Excel（测试同事不用Jira，只用Excel）

处理方式（滚动更新策略，避免月底上下文爆炸）：
- 每周让Claude总结5天内容，产出 `Feb-W1` 等周报
- 同时每周更新一次 `Feb Summary Rpt`（始终保持"可交付状态"）
- 月底产出：绩效评语、考评、成本统计、月报 → Obsidian Markdown Skill → PDF → 邮件发出

### 2. 项目售前（细节待展开）
### 3. 项目交付验收（细节待展开）

---

## Daemon设计要点

### 心跳/巡视逻辑（参考OpenClaw做法，尚未实现）
- 用户无操作时，自动巡视已提交文档
- 整理更新统计表
- 按项目管理规范识别项目风险
- 以"应对策略建议"形式通过Diana推送给用户

### 钉钉/飞书SDK接入（尚未实现）
- Daemon通过SDK持续拉取用户本身的对话记录
- 将零散讨论整理为：**待办**（→ macOS提醒事项）/ **重要时间点**（→ Diana通知）

### 群聊"递小纸条"功能（核心差异点，尚未实现）
当群聊中有人提及相关项目/成本数据时，Daemon提取相关概要，由Diana在用户参会前推送摘要。
效果：用户在有具体数据的情况下参会，而非当场说"我再去查查"。

---

## 当前代码状态评估（2026-02-24）

### 已实现
| 模块 | 状态 |
|------|------|
| CLI主界面（Ink/React） | ✅ 完成 |
| 多模型Provider（Anthropic/Google/OpenAI兼容/Mistral） | ✅ 完成 |
| 基础工具集（文件读写/命令执行/Git/搜索/Skill加载） | ✅ 完成 |
| Daemon框架（进程管理PID/HTTP server/路由/日志） | ✅ 框架完成 |
| MCP集成入口 | ✅ 完成 |
| Skill Manager | ✅ 完成 |

### 明显缺口
| 模块 | 状态 |
|------|------|
| Daemon心跳/巡视定时任务 | ❌ 未实现 |
| Diana（通知推送实现） | ❌ 仅有文档，无代码 |
| 钉钉/飞书SDK接入 | ❌ 未实现 |
| Obsidian Vault感知逻辑 | ❌ 未实现（有文件工具但无Vault语义） |
| Experience系统（~/.alice/experiences/） | ❌ 未实现（system prompt提及但无代码） |

### 昨天的Bug修复
`src/daemon/processManager.ts` 缺少import，由Cursor补上，现已正常（imports: `fs`, `path`, `spawn`, `os`, `DaemonConfig`）。

---

## 目标用户定位

- **核心用户**：有AI工具经验的PM/项目经理（中国大陆 + 日本企业）
- **差异化**：不同于Cowork等通用工具，Alice是专为"项目型团队文档工作流"设计的，降低使用门槛，职场新人也能安全使用
- **地域特殊性**：钉钉/飞书在中国企业的渗透率远超Slack/Teams，这是产品必须适配的现实

---

## 下一步方向（本次会话结束时的判断）

优先级从高到低：
1. **Daemon心跳机制** — 定时任务框架，巡视Vault，生成风险提示
2. **Experience系统** — ~/.alice/experiences/ 的读写实现，让Alice真正"记住"环境
3. **Diana通知通道** — 先从macOS本地通知开始，再扩展到IM
4. **钉钉/飞书SDK** — 对话记录摄取，待办提取

---

---

## 2026-02-24 晨 — Workspace绑定Session修复

**问题**：Alice在非项目目录启动时，workspace固定为Daemon启动目录，而非用户当前目录。

**根本原因**：Daemon是后台进程，`process.cwd()`永远是它自己启动时的目录。

**方案**：Workspace绑定到Session，不绑定进程。这是用户自己想到的方案，比最初的`baseDir`传参方案更优雅。

**改动的4个文件**：
1. `src/types/index.ts` — `Session`接口加`workspace: string`字段
2. `src/core/session.ts` — `createSession(workspace?)`接收workspace参数，fallback到`config.workspace`或`process.cwd()`
3. `src/daemon/routes.ts` — `POST /session`从请求body读取workspace传给createSession，日志记录workspace
4. `src/utils/daemonClient.ts` — `createSession()`发请求时带上`process.cwd()`
5. `src/daemon/chatHandler.ts` — 从session取workspace，动态注入system prompt告知模型当前工作目录
6. `src/daemon/services.ts` — `getLLMClient`缓存key改为`modelName::promptHash`，避免不同workspace共用同一client

**设计原则**：workspace注入system prompt，让模型在生成工具调用时主动使用绝对路径，不依赖`process.chdir()`。

**构建状态**：TypeScript编译通过，零错误。

---

*此文件用于跨会话恢复上下文。如需继续此节点的工作，将此文件贴给新会话的Claude即可。*
