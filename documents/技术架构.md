---
title: æŠ€æœ¯æ¶æ„
aliases: [æ¶æ„è®¾è®¡, Architecture]
tags: [æŠ€æœ¯æ–‡æ¡£, æ¶æ„, ç³»ç»Ÿè®¾è®¡]
date: 2026-02-14
version: 1.1.0
status: å·²å®ç°
---

# ALICE CLI æŠ€æœ¯æ¶æ„ ğŸ—ï¸

> **æ¶æ„ç†å¿µ**: æ¨¡å—åŒ–ã€å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€æ˜“ç»´æŠ¤

## ğŸ“ æ•´ä½“æ¶æ„

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Banner  â”‚  Header  â”‚ChatArea  â”‚  InputBox    â”‚  â”‚
â”‚  â”‚ (åŠ¨ç”»)   â”‚ (ä¿¡æ¯æ ) â”‚(å¯¹è¯åŒº)  â”‚ (è¾“å…¥)       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚StatusBar â”‚ToolCall  â”‚Dangerous â”‚  Spinner     â”‚  â”‚
â”‚  â”‚ (çŠ¶æ€)   â”‚Status    â”‚Confirm   â”‚ (åŠ è½½)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              Ink (React for CLI)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åº”ç”¨é€»è¾‘å±‚ (App Layer)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  App.tsx (ä¸»åº”ç”¨)                            â”‚    â”‚
â”‚  â”‚  - çŠ¶æ€ç®¡ç† (useState, useEffect)           â”‚    â”‚
â”‚  â”‚  - äº‹ä»¶å¤„ç† (useInput)                      â”‚    â”‚
â”‚  â”‚  - ç»„ä»¶ç¼–æ’                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ ¸å¿ƒä¸šåŠ¡å±‚ (Core Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  LLMClient   â”‚  â”‚ToolExecutor  â”‚                 â”‚
â”‚  â”‚  (èŠå¤©)      â”‚  â”‚(å·¥å…·è°ƒç”¨)    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚Â· æ¶ˆæ¯ç®¡ç†    â”‚  â”‚Â· å·¥å…·æ³¨å†Œ    â”‚                 â”‚
â”‚  â”‚Â· æµå¼è¾“å‡º    â”‚  â”‚Â· å‚æ•°éªŒè¯    â”‚                 â”‚
â”‚  â”‚Â· æ™ºèƒ½é™çº§    â”‚  â”‚Â· ç»“æœæ”¶é›†    â”‚                 â”‚
â”‚  â”‚Â· Provider    â”‚  â”‚Â· é”™è¯¯å¤„ç†    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                 â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   SessionManager (ä¼šè¯)        â”‚                 â”‚
â”‚  â”‚   StatusManager (çŠ¶æ€)         â”‚                 â”‚
â”‚  â”‚   ConfigManager (é…ç½®)         â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®è®¿é—®å±‚ (Data Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚Provideré€‚é… â”‚  â”‚  Tools       â”‚                  â”‚
â”‚  â”‚             â”‚  â”‚  Registry    â”‚                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚  â”‚OpenAI Compatâ”‚  â”‚8 ä¸ªå†…ç½®å·¥å…·  â”‚                  â”‚
â”‚  â”‚Â· LMStudio   â”‚  â”‚Â· readFile    â”‚                  â”‚
â”‚  â”‚Â· Ollama     â”‚  â”‚Â· listFiles   â”‚                  â”‚
â”‚  â”‚Â· OpenAI     â”‚  â”‚Â· searchFiles â”‚                  â”‚
â”‚  â”‚Â· Azure      â”‚  â”‚Â· getCurrentÂ·Â·â”‚                 â”‚
â”‚  â”‚Â· Custom     â”‚  â”‚  ...         â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM æœåŠ¡         â”‚  â”‚   ç³»ç»Ÿ API                   â”‚
â”‚ Â· LM Studio       â”‚  â”‚ Â· æ–‡ä»¶ç³»ç»Ÿ (fs)              â”‚
â”‚ Â· Ollama          â”‚  â”‚ Â· Git (simple-git)           â”‚
â”‚ Â· OpenAI          â”‚  â”‚ Â· ç³»ç»Ÿå‘½ä»¤ (child_process)   â”‚
â”‚ Â· Azure           â”‚  â”‚ Â· Glob (æ–‡ä»¶æœç´¢)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§© æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. UI å±‚ (cli/)

#### ç»„ä»¶æ¶æ„

```typescript
// ä¸»åº”ç”¨ç»„ä»¶
export const App: React.FC<AppProps> = ({ config }) => {
  // çŠ¶æ€ç®¡ç†
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  
  // æ ¸å¿ƒæœåŠ¡
  const llmClient = useMemo(() => new LLMClient(config), [config]);
  const toolExecutor = useMemo(() => new ToolExecutor(), []);
  
  // äº‹ä»¶å¤„ç†
  useInput((input, key) => {
    if (key.return) handleSend();
    if (key.upArrow) handleHistory('up');
    if (key.downArrow) handleHistory('down');
  });
  
  // æ¸²æŸ“
  return (
    <Box flexDirection="column">
      <Header workspace={config.workspace} model={currentModel} />
      <ChatArea messages={messages} />
      <InputBox value={input} onChange={setInput} />
      <StatusBar status={connectionStatus} />
    </Box>
  );
};
```

#### ç»„ä»¶æ¸…å•

| ç»„ä»¶ | èŒè´£ | æ–‡ä»¶ |
|------|------|------|
| `App` | ä¸»åº”ç”¨ï¼ŒçŠ¶æ€ç®¡ç† | `app.tsx` |
| `Banner` | å¯åŠ¨åŠ¨ç”» | `components/Banner.tsx` |
| `Header` | é¡¶éƒ¨ä¿¡æ¯æ  | `components/Header.tsx` |
| `ChatArea` | å¯¹è¯å±•ç¤ºåŒº | `components/ChatArea.tsx` |
| `InputBox` | è¾“å…¥æ¡† | `components/InputBox.tsx` |
| `StatusBar` | çŠ¶æ€æ  | `components/StatusBar.tsx` |
| `ToolCallStatus` | å·¥å…·æ‰§è¡ŒçŠ¶æ€ | `components/ToolCallStatus.tsx` |
| `DangerousCommandConfirm` | å±é™©å‘½ä»¤ç¡®è®¤ | `components/DangerousCommandConfirm.tsx` |
| `StreamingMessage` | æµå¼AIå“åº”æ¸²æŸ“ | `components/StreamingMessage.tsx` |
| `Markdown` | å†å²æ¶ˆæ¯æ¸²æŸ“ | `components/Markdown.tsx` |

### 2. æ ¸å¿ƒå±‚ (core/)

#### LLMClient è®¾è®¡

```typescript
export class LLMClient {
  private provider: BaseLLMProvider;
  private config: ModelConfig;
  private fallbackProvider?: BaseLLMProvider;
  
  constructor(config: ModelConfig) {
    this.config = config;
    this.provider = createProvider(config);
    
    // æ™ºèƒ½é™çº§: å¦‚æœé…ç½®äº†å¤‡ç”¨æ¨¡å‹
    if (config.suggest_model && config.suggest_model !== config.default_model) {
      const fallbackConfig = config.models.find(m => m.name === config.suggest_model);
      if (fallbackConfig) {
        this.fallbackProvider = createProvider(fallbackConfig);
      }
    }
  }
  
  // æµå¼èŠå¤©
  async *chat(messages: Message[]): AsyncGenerator<string> {
    try {
      // å°è¯•ä¸»æ¨¡å‹
      yield* this.provider.createChatCompletion(messages);
    } catch (error) {
      // é™çº§åˆ°å¤‡ç”¨æ¨¡å‹
      if (this.fallbackProvider) {
        console.warn('ä¸»æ¨¡å‹å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹');
        yield* this.fallbackProvider.createChatCompletion(messages);
      } else {
        throw error;
      }
    }
  }
  
  // Function Calling
  async chatWithTools(
    messages: Message[], 
    tools: ToolDefinition[]
  ): Promise<ChatResponse> {
    return await this.provider.createChatCompletion(messages, tools);
  }
}
```

#### Provider æ¶æ„

```typescript
// åŸºç±»
export abstract class BaseLLMProvider {
  protected config: ProviderConfig;
  
  abstract createChatCompletion(
    messages: Message[],
    tools?: ToolDefinition[]
  ): AsyncGenerator<string> | Promise<ChatResponse>;
  
  abstract testConnection(): Promise<boolean>;
}

// OpenAI å…¼å®¹å®ç°
export class OpenAICompatibleProvider extends BaseLLMProvider {
  private axios: AxiosInstance;
  
  constructor(config: ProviderConfig) {
    super(config);
    this.axios = axios.create({
      baseURL: config.baseURL,
      headers: {
        'Authorization': `Bearer ${config.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
  }
  
  async *createChatCompletion(messages: Message[], tools?: ToolDefinition[]) {
    const response = await this.axios.post('/chat/completions', {
      model: this.config.model,
      messages,
      tools,
      stream: true,
      temperature: this.config.temperature,
      max_tokens: this.config.maxTokens
    }, {
      responseType: 'stream'
    });
    
    // è§£æ SSE æµ
    for await (const chunk of response.data) {
      const lines = chunk.toString().split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = JSON.parse(line.slice(6));
          if (data.choices[0].delta?.content) {
            yield data.choices[0].delta.content;
          }
        }
      }
    }
  }
}

// Factory
export function createProvider(config: ProviderConfig): BaseLLMProvider {
  switch (config.provider) {
    case 'lmstudio':
    case 'ollama':
    case 'openai':
    case 'azure':
    case 'custom':
      return new OpenAICompatibleProvider(config);
    default:
      throw new Error(`Unsupported provider: ${config.provider}`);
  }
}
```

#### ToolExecutor è®¾è®¡

```typescript
export class ToolExecutor {
  private registry: Map<string, ToolHandler> = new Map();
  
  constructor() {
    this.registerBuiltinTools();
  }
  
  // æ³¨å†Œå†…ç½®å·¥å…·
  private registerBuiltinTools() {
    this.register('readFile', readFileHandler);
    this.register('listFiles', listFilesHandler);
    this.register('searchFiles', searchFilesHandler);
    this.register('getCurrentDirectory', getCurrentDirectoryHandler);
    this.register('getGitInfo', getGitInfoHandler);
    this.register('getCurrentDateTime', getCurrentDateTimeHandler);
    this.register('executeCommand', executeCommandHandler);
  }
  
  // æ³¨å†Œå·¥å…·
  register(name: string, handler: ToolHandler) {
    this.registry.set(name, handler);
  }
  
  // æ‰§è¡Œå·¥å…·
  async execute(toolCall: ToolCall): Promise<ToolResult> {
    const handler = this.registry.get(toolCall.function.name);
    if (!handler) {
      return {
        success: false,
        error: `å·¥å…· ${toolCall.function.name} æœªæ‰¾åˆ°`
      };
    }
    
    try {
      // å‚æ•°éªŒè¯
      const params = JSON.parse(toolCall.function.arguments);
      
      // å±é™©å‘½ä»¤æ£€æŸ¥
      if (toolCall.function.name === 'executeCommand') {
        const shouldExecute = await confirmDangerousCommand(params.command);
        if (!shouldExecute) {
          return { success: false, error: 'ç”¨æˆ·å–æ¶ˆæ‰§è¡Œ' };
        }
      }
      
      // æ‰§è¡Œ
      const result = await handler(params);
      return { success: true, data: result };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }
  
  // è·å–æ‰€æœ‰å·¥å…·å®šä¹‰
  getToolDefinitions(): ToolDefinition[] {
    return Array.from(this.registry.keys()).map(name => ({
      type: 'function',
      function: this.getToolSchema(name)
    }));
  }
}
```

### 3. å·¥å…·å±‚ (tools/)

#### å·¥å…·å®šä¹‰ç¤ºä¾‹

```typescript
// è¯»å–æ–‡ä»¶å·¥å…·
export const readFileHandler: ToolHandler = async (params: { filePath: string }) => {
  const { filePath } = params;
  
  // å®‰å…¨æ£€æŸ¥
  if (!isPathSafe(filePath)) {
    throw new Error('ä¸å®‰å…¨çš„æ–‡ä»¶è·¯å¾„');
  }
  
  // è¯»å–æ–‡ä»¶
  const content = await fs.readFile(filePath, 'utf-8');
  
  return {
    filePath,
    content,
    size: content.length,
    lines: content.split('\n').length
  };
};

// å·¥å…· Schema
export const readFileSchema: FunctionSchema = {
  name: 'readFile',
  description: 'è¯»å–æ–‡ä»¶å†…å®¹',
  parameters: {
    type: 'object',
    properties: {
      filePath: {
        type: 'string',
        description: 'æ–‡ä»¶è·¯å¾„ (ç›¸å¯¹æˆ–ç»å¯¹)'
      }
    },
    required: ['filePath']
  }
};
```

#### å·¥å…·æ³¨å†Œè¡¨

```typescript
// tools/registry.ts
export const builtinTools: Record<string, ToolDefinition> = {
  readFile: {
    type: 'function',
    function: readFileSchema
  },
  listFiles: {
    type: 'function',
    function: listFilesSchema
  },
  searchFiles: {
    type: 'function',
    function: searchFilesSchema
  },
  getCurrentDirectory: {
    type: 'function',
    function: getCurrentDirectorySchema
  },
  getGitInfo: {
    type: 'function',
    function: getGitInfoSchema
  },
  getCurrentDateTime: {
    type: 'function',
    function: getCurrentDateTimeSchema
  },
  executeCommand: {
    type: 'function',
    function: executeCommandSchema
  }
};
```

### 4. æ¸²æŸ“ä¼˜åŒ–

#### Header é™æ€æ¸²æŸ“

ä½¿ç”¨ ink çš„ `<Static>` ç»„ä»¶åŒ…è£¹ Headerï¼Œç¡®ä¿åªæ¸²æŸ“ä¸€æ¬¡ï¼š

```typescript
<Static items={['header']}>
  {(item) => <Header key={item} ... />}
</Static>
```

#### Think å†…å®¹è§£æ

æ”¯æŒè§£æ `<think>` æ ‡ç­¾ï¼ˆDeepSeek/Qwen æ¨¡å‹æ€è€ƒè¿‡ç¨‹ï¼‰ï¼Œä»¥ç°è‰²åŒºåˆ†æ˜¾ç¤ºï¼š

```typescript
import { splitThinkContent } from '../utils/thinkParser.js';
const segments = splitThinkContent(content);
// segments: { type: 'think' | 'normal', content: string }[]
```

#### è¡¨æ ¼æ¸²æŸ“

ä½¿ç”¨ React ç»„ä»¶ï¼ˆ`TableRendererComponent`ï¼‰æ›¿ä»£ cli-table3 å­—ç¬¦ä¸²æ¸²æŸ“ï¼Œé€šè¿‡ ink çš„è™šæ‹Ÿ DOM diffing å‡å°‘ç»ˆç«¯é‡ç»˜ï¼š

```typescript
import { TableRendererComponent } from '../utils/tableRenderer.js';
// ä½¿ç”¨ string-width è®¡ç®— CJK/emoji å­—ç¬¦å®½åº¦
```

## ğŸ“¦ æ•°æ®æµ

### 1. åŸºç¡€å¯¹è¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant UI as InputBox
    participant App as App
    participant LLM as LLMClient
    participant P as Provider
    participant API as LLM API
    
    U->>UI: è¾“å…¥æ¶ˆæ¯
    UI->>App: è§¦å‘ onSend
    App->>LLM: chat(messages)
    LLM->>P: createChatCompletion
    P->>API: POST /chat/completions (stream)
    
    loop æµå¼å“åº”
        API-->>P: SSE chunk
        P-->>LLM: yield content
        LLM-->>App: yield content
        App->>App: æ›´æ–° messages state
    end
    
    App-->>U: æ˜¾ç¤ºå®Œæ•´å“åº”
```

### 2. Function Calling æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant App as App
    participant LLM as LLMClient
    participant API as LLM API
    participant TE as ToolExecutor
    participant Tool as Tool Handler
    
    U->>App: "è¯»å– package.json"
    App->>LLM: chat(messages, tools)
    LLM->>API: POST (with tools)
    API-->>LLM: response with tool_calls
    
    loop æ¯ä¸ª tool_call
        LLM->>TE: execute(tool_call)
        TE->>Tool: handler(params)
        Tool-->>TE: result
        TE-->>LLM: ToolResult
    end
    
    LLM->>LLM: è¿½åŠ  tool results åˆ° messages
    LLM->>API: POST (continue conversation)
    API-->>LLM: æœ€ç»ˆå“åº”
    LLM-->>App: æ˜¾ç¤ºç»“æœ
```

### 3. æ™ºèƒ½é™çº§æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·å‘é€æ¶ˆæ¯] --> B[å°è¯•ä¸»æ¨¡å‹]
    B --> C{è¿æ¥æˆåŠŸ?}
    C -->|æ˜¯| D[æ­£å¸¸å“åº”]
    C -->|å¦| E{æœ‰å¤‡ç”¨æ¨¡å‹?}
    E -->|æ˜¯| F[åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹]
    E -->|å¦| G[æŠ›å‡ºé”™è¯¯]
    F --> H[æ˜¾ç¤ºé™çº§æç¤º]
    H --> I[ä½¿ç”¨å¤‡ç”¨æ¨¡å‹å“åº”]
    D --> J[å®Œæˆ]
    I --> J
    G --> K[æ˜¾ç¤ºé”™è¯¯]
```

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„

```
alice-cli/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.tsx                    # å…¥å£æ–‡ä»¶
â”‚   â”‚   - å‘½ä»¤è¡Œå‚æ•°è§£æ
â”‚   â”‚   - é…ç½®åŠ è½½
â”‚   â”‚   - App å¯åŠ¨
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/                         # UI å±‚
â”‚   â”‚   â”œâ”€â”€ app.tsx                  # ä¸»åº”ç”¨
â”‚   â”‚   â””â”€â”€ components/              # React ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ Banner.tsx
â”‚   â”‚       â”œâ”€â”€ Header.tsx
â”‚   â”‚       â”œâ”€â”€ ChatArea.tsx
â”‚   â”‚       â”œâ”€â”€ InputBox.tsx
â”‚   â”‚       â”œâ”€â”€ StatusBar.tsx
â”‚   â”‚       â”œâ”€â”€ ToolCallStatus.tsx
â”‚   â”‚       â””â”€â”€ DangerousCommandConfirm.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                        # æ ¸å¿ƒå±‚
â”‚   â”‚   â”œâ”€â”€ llm.ts                   # LLM å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ providers/               # Provider é€‚é…å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ base.ts              # åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ openai-compatible.ts # OpenAI å…¼å®¹
â”‚   â”‚   â”‚   â””â”€â”€ index.ts             # Factory
â”‚   â”‚   â”œâ”€â”€ session.ts               # ä¼šè¯ç®¡ç†
â”‚   â”‚   â””â”€â”€ statusManager.ts         # çŠ¶æ€ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/                       # å·¥å…·å±‚
â”‚   â”‚   â”œâ”€â”€ executor.ts              # å·¥å…·æ‰§è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ registry.ts              # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ builtin/                 # å†…ç½®å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ readFile.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ listFiles.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ searchFiles.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ getCurrentDirectory.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ getGitInfo.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ getCurrentDateTime.ts
â”‚   â”‚   â”‚   â””â”€â”€ executeCommand.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                       # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ config.ts                # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ thinkParser.ts           # Thinkæ ‡ç­¾è§£æ
â”‚   â”‚   â”œâ”€â”€ tableRenderer.tsx        # Reactè¡¨æ ¼æ¸²æŸ“ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ test-model.ts            # æ¨¡å‹æµ‹é€Ÿ
â”‚   â”‚   â””â”€â”€ test-function-calling.ts # FC æµ‹è¯•
â”‚   â”‚
â”‚   â””â”€â”€ types/                       # ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ index.ts                 # é€šç”¨ç±»å‹
â”‚       â””â”€â”€ tool.ts                  # å·¥å…·ç±»å‹
â”‚
â”œâ”€â”€ agents/                          # Agent é…ç½®
â”‚   â””â”€â”€ system_prompt.md             # ç³»ç»Ÿæç¤ºè¯
â”‚
â”œâ”€â”€ dist/                            # æ„å»ºè¾“å‡º
â”œâ”€â”€ package.json                     # é¡¹ç›®é…ç½®
â”œâ”€â”€ tsconfig.json                    # TypeScript é…ç½®
â””â”€â”€ README.md                        # æ–‡æ¡£
```

## âš™ï¸ é…ç½®ç³»ç»Ÿ

### é…ç½®æ–‡ä»¶ç»“æ„

```typescript
// ~/.alice/settings.jsonc
interface AliceConfig {
  // æ¨¡å‹é…ç½®
  default_model: string;      // é»˜è®¤æ¨¡å‹åç§°
  suggest_model: string;      // æ¨èæœ€å¿«æ¨¡å‹
  models: ModelConfig[];      // æ¨¡å‹åˆ—è¡¨
  
  // UI é…ç½®
  ui: {
    banner: {
      enabled: boolean;       // æ˜¯å¦æ˜¾ç¤º Banner
      style: BannerStyle;     // åŠ¨ç”»é£æ ¼
    };
    theme: ThemeType;         // ä¸»é¢˜
  };
  
  // å·¥ä½œåŒº
  workspace: string;          // å½“å‰å·¥ä½œç›®å½•
  
  // å®‰å…¨
  dangerous_cmd: boolean;     // å±é™©å‘½ä»¤ç¡®è®¤
}

interface ModelConfig {
  name: string;               // æ¨¡å‹åç§°
  provider: ProviderType;     // æä¾›å•†
  baseURL: string;            // API åœ°å€
  model: string;              // æ¨¡å‹ ID
  apiKey: string;             // API Key
  temperature: number;        // æ¸©åº¦
  maxTokens: number;          // æœ€å¤§ Token
  last_update_datetime: string | null; // æœ€åæ›´æ–°æ—¶é—´
  speed: number | null;       // é€Ÿåº¦ (tokens/s)
}
```

### é…ç½®åŠ è½½æµç¨‹

```typescript
export class ConfigManager {
  private configPath: string;
  private config: AliceConfig;
  
  async load(): Promise<AliceConfig> {
    // 1. å®šä½é…ç½®æ–‡ä»¶
    this.configPath = path.join(os.homedir(), '.alice', 'settings.jsonc');
    
    // 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨
    if (!await fs.pathExists(this.configPath)) {
      // åˆ›å»ºé»˜è®¤é…ç½®
      await this.createDefaultConfig();
    }
    
    // 3. è¯»å–å¹¶è§£æ JSONC
    const content = await fs.readFile(this.configPath, 'utf-8');
    this.config = jsonc.parse(content);
    
    // 4. ç¯å¢ƒå˜é‡æ›¿æ¢
    this.config = this.resolveEnvVars(this.config);
    
    // 5. éªŒè¯é…ç½®
    this.validate(this.config);
    
    return this.config;
  }
  
  private resolveEnvVars(config: any): any {
    const json = JSON.stringify(config);
    const resolved = json.replace(/\$\{(\w+)\}/g, (_, varName) => {
      return process.env[varName] || '';
    });
    return JSON.parse(resolved);
  }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. å¯åŠ¨ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æ–¹æ¡ˆ | æ•ˆæœ |
|--------|------|------|
| **æŒ‰éœ€åŠ è½½** | åŠ¨æ€ import éæ ¸å¿ƒæ¨¡å— | -200ms |
| **é…ç½®ç¼“å­˜** | ç¼“å­˜è§£æåçš„é…ç½® | -50ms |
| **å¹¶è¡Œåˆå§‹åŒ–** | åŒæ—¶åŠ è½½ UI å’Œæ ¸å¿ƒæ¨¡å— | -100ms |

### 2. è¿è¡Œæ—¶ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æ–¹æ¡ˆ | æ•ˆæœ |
|--------|------|------|
| **æµå¼æ¸²æŸ“** | SSE é€å­—æ¸²æŸ“ | ä½“éªŒæå‡ |
| **è™šæ‹Ÿæ»šåŠ¨** | é•¿å¯¹è¯å†å²è™šæ‹ŸåŒ– | å†…å­˜ -30% |
| **é˜²æŠ–èŠ‚æµ** | è¾“å…¥é˜²æŠ– | CPU -20% |

### 3. å†…å­˜ä¼˜åŒ–

```typescript
// ä¼šè¯å†å²é™åˆ¶
const MAX_MESSAGES = 100;

// å®šæœŸæ¸…ç†
setInterval(() => {
  if (messages.length > MAX_MESSAGES) {
    messages = messages.slice(-MAX_MESSAGES);
  }
}, 60000);
```

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. å±é™©å‘½ä»¤æ£€æµ‹

```typescript
const DANGEROUS_PATTERNS = [
  /rm\s+-rf/,           // åˆ é™¤
  /sudo/,               // ææƒ
  /chmod\s+777/,        // æƒé™ä¿®æ”¹
  />\s*\/dev\/sda/,     // ç£ç›˜æ“ä½œ
  /mkfs/,               // æ ¼å¼åŒ–
  /dd\s+if=/,           // ç£ç›˜å¤åˆ¶
];

function isDangerousCommand(cmd: string): boolean {
  return DANGEROUS_PATTERNS.some(pattern => pattern.test(cmd));
}
```

### 2. è·¯å¾„å®‰å…¨

```typescript
function isPathSafe(filePath: string): boolean {
  const resolved = path.resolve(filePath);
  const workspace = path.resolve(config.workspace);
  
  // ä¸å…è®¸è®¿é—®å·¥ä½œåŒºå¤–çš„æ–‡ä»¶
  return resolved.startsWith(workspace);
}
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ç³»ç»Ÿ

```typescript
export class Logger {
  private level: LogLevel;
  
  debug(message: string, data?: any) {
    if (this.level >= LogLevel.DEBUG) {
      console.log(`[DEBUG] ${message}`, data);
    }
  }
  
  info(message: string) {
    console.log(chalk.blue(`[INFO] ${message}`));
  }
  
  warn(message: string) {
    console.log(chalk.yellow(`[WARN] ${message}`));
  }
  
  error(message: string, error?: Error) {
    console.error(chalk.red(`[ERROR] ${message}`), error);
  }
}
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [Node.js æœ€ä½³å®è·µ](https://github.com/goldbergyoni/nodebestpractices)
- [TypeScript æ‰‹å†Œ](https://www.typescriptlang.org/docs/)
- [React æ–‡æ¡£](https://react.dev/)
- [Ink æ–‡æ¡£](https://github.com/vadimdemedes/ink)

---

**[[äº§å“éœ€æ±‚æ–‡æ¡£|è¿”å› PRD ä¸»é¡µ]]**
