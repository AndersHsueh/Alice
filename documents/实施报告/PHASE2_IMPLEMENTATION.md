# Phase 2: LLM Function Calling é›†æˆå®Œæˆ

## ğŸ“‹ å®ç°æ¦‚è§ˆ

å·²æˆåŠŸå®Œæˆ Phase 2 çš„ LLM Function Calling é›†æˆï¼Œå®ç°äº†å®Œæ•´çš„å·¥å…·è°ƒç”¨å¾ªç¯ã€‚

## âœ… å®ŒæˆåŠŸèƒ½

### 1. ç±»å‹ç³»ç»Ÿæ‰©å±• âœ“

**æ–‡ä»¶**: `src/types/index.ts`, `src/types/tool.ts`

- **Message æ¥å£æ‰©å±•**
  - æ–°å¢ `tool` è§’è‰²æ”¯æŒ
  - æ·»åŠ  `tool_calls` å­—æ®µï¼ˆassistant æ¶ˆæ¯æºå¸¦ï¼‰
  - æ·»åŠ  `tool_call_id` å’Œ `name` å­—æ®µï¼ˆtool æ¶ˆæ¯ä½¿ç”¨ï¼‰

### 2. Provider æ¥å£å‡çº§ âœ“

**æ–‡ä»¶**: `src/core/providers/base.ts`

- **æ–°å¢ç±»å‹**
  - `ChatResponse`: åŒºåˆ†æ–‡æœ¬å“åº”å’Œå·¥å…·è°ƒç”¨å“åº”
  
- **æ–°å¢æŠ½è±¡æ–¹æ³•**
  - `chatWithTools()`: éæµå¼å·¥å…·å¯¹è¯
  - `chatStreamWithTools()`: æµå¼å·¥å…·å¯¹è¯

- **æ”¹è¿› buildMessages**
  - æ­£ç¡®å¤„ç† `tool` è§’è‰²æ¶ˆæ¯
  - æ”¯æŒ assistant å¸¦ tool_calls
  - ä¿æŒå‘åå…¼å®¹

### 3. OpenAI å…¼å®¹ Provider å®ç° âœ“

**æ–‡ä»¶**: `src/core/providers/openai-compatible.ts`

#### chatWithTools() æ–¹æ³•
- æ„å»ºå¸¦ tools å‚æ•°çš„è¯·æ±‚
- ä½¿ç”¨ `tool_choice: 'auto'` è®© LLM è‡ªåŠ¨å†³å®š
- è§£æå“åº”åˆ¤æ–­æ˜¯æ–‡æœ¬è¿˜æ˜¯å·¥å…·è°ƒç”¨
- è¿”å›ç»Ÿä¸€çš„ `ChatResponse` æ ¼å¼

#### chatStreamWithTools() æ–¹æ³•
- æµå¼å¤„ç† SSE å“åº”
- **ç´¯ç§¯å·¥å…·è°ƒç”¨**ï¼ˆå…³é”®å®ç°ï¼‰
  - å·¥å…·è°ƒç”¨ä»¥å¢é‡æ–¹å¼è¿”å›
  - æŒ‰ index ç»„è£…å®Œæ•´çš„å·¥å…·è°ƒç”¨
  - ç´¯ç§¯ function.name å’Œ function.arguments
- åŒæ—¶æ”¯æŒæ–‡æœ¬å†…å®¹å’Œå·¥å…·è°ƒç”¨
- åœ¨æµç»“æŸæ—¶è¿”å›å®Œæ•´çš„å·¥å…·è°ƒç”¨åˆ—è¡¨

### 4. LLMClient å·¥å…·é›†æˆ âœ“

**æ–‡ä»¶**: `src/core/llm.ts`

#### æ–°å¢æ–¹æ³•

1. **enableTools(config: Config)**
   - åˆå§‹åŒ– ToolExecutor
   - å¯ç”¨å·¥å…·æ”¯æŒ

2. **setConfirmHandler(handler)**
   - è®¾ç½®å±é™©å‘½ä»¤ç¡®è®¤å›è°ƒ
   - ç”¨äº UI äº¤äº’

3. **chatWithTools(messages, onToolUpdate)**
   - éæµå¼å·¥å…·å¯¹è¯
   - å®ç°å·¥å…·è°ƒç”¨å¾ªç¯ï¼š
     ```
     å‘é€æ¶ˆæ¯ â†’ LLM å“åº” â†’ æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
       â†“ æœ‰å·¥å…·è°ƒç”¨
     æ‰§è¡Œå·¥å…· â†’ åé¦ˆç»“æœ â†’ ç»§ç»­å¾ªç¯
       â†“ æ— å·¥å…·è°ƒç”¨
     è¿”å›æ–‡æœ¬å“åº”
     ```
   - é˜²æ­¢æ— é™å¾ªç¯ï¼ˆæœ€å¤§ 5 æ¬¡è¿­ä»£ï¼‰
   - å®æ—¶é€šçŸ¥å·¥å…·æ‰§è¡ŒçŠ¶æ€

4. **chatStreamWithTools(messages, onToolUpdate)**
   - æµå¼å·¥å…·å¯¹è¯
   - è¾¹è¾“å‡ºæ–‡æœ¬è¾¹å¤„ç†å·¥å…·è°ƒç”¨
   - å·¥å…·æ‰§è¡Œåç»§ç»­æµå¼è¾“å‡º LLM çš„åç»­å“åº”
   - å®Œæ•´çš„å·¥å…·è°ƒç”¨å¾ªç¯æ”¯æŒ

## ğŸ”„ å·¥å…·è°ƒç”¨æµç¨‹

### éæµå¼æµç¨‹
```
ç”¨æˆ·è¾“å…¥
  â†“
LLMClient.chatWithTools()
  â†“
Provider.chatWithTools()
  â†“
LLM å“åº”ï¼ˆå¸¦å·¥å…·å®šä¹‰ï¼‰
  â†“
åˆ¤æ–­å“åº”ç±»å‹
  â”œâ”€ type='text' â†’ è¿”å›æ–‡æœ¬
  â””â”€ type='tool_calls' â†’ æ‰§è¡Œå·¥å…·
       â†“
     ToolExecutor.executeAll()
       â†“
     å·¥å…·ç»“æœä½œä¸ºæ–°æ¶ˆæ¯
       â†“
     å†æ¬¡è°ƒç”¨ LLM â†’ ç”Ÿæˆæœ€ç»ˆå›å¤
```

### æµå¼æµç¨‹
```
ç”¨æˆ·è¾“å…¥
  â†“
LLMClient.chatStreamWithTools()
  â†“
Provider.chatStreamWithTools()
  â†“
æµå¼è¾“å‡ºï¼ˆåŒæ—¶ç´¯ç§¯å·¥å…·è°ƒç”¨ï¼‰
  â”œâ”€ æ–‡æœ¬ç‰‡æ®µ â†’ yield ç»™ç”¨æˆ·
  â””â”€ å·¥å…·è°ƒç”¨ç‰‡æ®µ â†’ ç´¯ç§¯
       â†“
     æµç»“æŸåæ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
       â†“ æœ‰
     æ‰§è¡Œå·¥å…· â†’ åé¦ˆç»“æœ
       â†“
     ç»§ç»­æµå¼è·å–åç»­å“åº”
```

## ğŸ“¦ æ–°å¢æ–‡ä»¶

```
src/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ test-function-calling.ts  [æ–°å¢] Function Calling æµ‹è¯•è„šæœ¬
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ llm.ts                     [ä¿®æ”¹] æ·»åŠ å·¥å…·æ”¯æŒ
â”‚   â””â”€â”€ providers/
â”‚       â”œâ”€â”€ base.ts                [ä¿®æ”¹] æ–°å¢ chatWithTools æ¥å£
â”‚       â””â”€â”€ openai-compatible.ts   [ä¿®æ”¹] å®ç° Function Calling
â””â”€â”€ types/
    â””â”€â”€ index.ts                   [ä¿®æ”¹] æ‰©å±• Message ç±»å‹
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### ç¼–è¯‘çŠ¶æ€
```bash
npm run build
# âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
```

### æµ‹è¯•è„šæœ¬
```bash
node dist/utils/test-function-calling.js
```

**æµ‹è¯•åœºæ™¯**:
1. ç®€å•å·¥å…·è°ƒç”¨ï¼ˆè·å–å½“å‰æ—¶é—´ï¼‰
2. æµå¼å·¥å…·è°ƒç”¨ï¼ˆæœç´¢æ–‡ä»¶ï¼‰

### æ³¨æ„äº‹é¡¹
âš ï¸ **LM Studio å…¼å®¹æ€§**
- LM Studio çš„ Function Calling æ”¯æŒå–å†³äºç‰ˆæœ¬å’Œæ¨¡å‹
- éƒ¨åˆ†æ—§ç‰ˆæœ¬æˆ–æ¨¡å‹å¯èƒ½ä¸æ”¯æŒ `tools` å‚æ•°
- å¦‚é‡åˆ° 400 é”™è¯¯ï¼Œå¯èƒ½æ˜¯æ¨¡å‹ä¸æ”¯æŒ Function Calling
- å»ºè®®ä½¿ç”¨æ”¯æŒ Function Calling çš„æ¨¡å‹ï¼ˆå¦‚ GPT-3.5/4ï¼‰

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®ç°
1. **å®Œæ•´çš„å·¥å…·è°ƒç”¨å¾ªç¯** - æ”¯æŒå¤šè½®å·¥å…·äº¤äº’
2. **æµå¼å’Œéæµå¼æ”¯æŒ** - ä¸¤ç§æ¨¡å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œ
3. **å¹¶å‘å·¥å…·è°ƒç”¨** - æ”¯æŒä¸€æ¬¡è°ƒç”¨å¤šä¸ªå·¥å…·
4. **é˜²æ— é™å¾ªç¯** - æœ€å¤§è¿­ä»£æ¬¡æ•°é™åˆ¶
5. **å®æ—¶çŠ¶æ€åé¦ˆ** - onToolUpdate å›è°ƒ
6. **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸æ•è·å’Œæç¤º
7. **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰çš„æ™®é€šå¯¹è¯åŠŸèƒ½

### ğŸ”‘ å…³é”®å®ç°ç»†èŠ‚

#### 1. æµå¼å·¥å…·è°ƒç”¨ç´¯ç§¯
```typescript
// å…³é”®ï¼šå·¥å…·è°ƒç”¨ä»¥å¢é‡æ–¹å¼è¿”å›
if (delta.tool_calls) {
  for (const toolCall of delta.tool_calls) {
    const index = toolCall.index;
    
    // åˆå§‹åŒ–æˆ–æ›´æ–°
    if (!accumulatedToolCalls[index]) {
      accumulatedToolCalls[index] = { /* ... */ };
    }
    
    // ç´¯ç§¯å‚æ•°å­—ç¬¦ä¸²
    if (toolCall.function?.arguments) {
      accumulatedToolCalls[index].function.arguments += 
        toolCall.function.arguments;
    }
  }
}
```

#### 2. å·¥å…·è°ƒç”¨å¾ªç¯
```typescript
while (iteration < maxIterations) {
  const response = await provider.chatWithTools(messages, tools);
  
  if (response.type === 'tool_calls') {
    // æ‰§è¡Œå·¥å…·
    const results = await executor.executeAll(response.tool_calls);
    
    // æ·»åŠ å·¥å…·ç»“æœåˆ°å¯¹è¯
    messages.push(...toolResultMessages);
    
    // ç»§ç»­å¾ªç¯
    continue;
  }
  
  // è¿”å›æœ€ç»ˆæ–‡æœ¬å“åº”
  return response;
}
```

#### 3. æ¶ˆæ¯æ ¼å¼è½¬æ¢
```typescript
// assistant å¸¦å·¥å…·è°ƒç”¨
{
  role: 'assistant',
  content: '',
  tool_calls: [{ id, type, function: { name, arguments } }]
}

// tool ç»“æœæ¶ˆæ¯
{
  role: 'tool',
  tool_call_id: '...',
  name: 'readFile',
  content: '{"success": true, "data": {...}}'
}
```

## ğŸš€ ä¸‹ä¸€æ­¥ï¼ˆPhase 5ï¼‰

ä¸ºäº†å®Œæ•´å¯ç”¨ Function Callingï¼Œè¿˜éœ€è¦ï¼š

1. **é›†æˆåˆ°ä¸»åº”ç”¨ UI** (`src/cli/app.tsx`)
   - åœ¨åˆå§‹åŒ–æ—¶æ³¨å†Œå·¥å…·
   - ä½¿ç”¨ `chatStreamWithTools` æ›¿ä»£ `chatStream`
   - å±•ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€ï¼ˆToolCallStatus ç»„ä»¶ï¼‰
   - å®ç°å±é™©å‘½ä»¤ç¡®è®¤å¯¹è¯æ¡†

2. **æ›´æ–°ç³»ç»Ÿæç¤ºè¯** (`agents/system_prompt.md`)
   - æ·»åŠ å·¥å…·ä½¿ç”¨æŒ‡å—
   - å‘ŠçŸ¥ AI å¯ç”¨çš„å·¥å…·
   - æä¾›å·¥å…·ä½¿ç”¨ç¤ºä¾‹

3. **ç”¨æˆ·æ–‡æ¡£**
   - å¦‚ä½•å¯ç”¨/ç¦ç”¨å·¥å…·
   - é…ç½® dangerous_cmd
   - å·¥å…·ä½¿ç”¨ç¤ºä¾‹

4. **å®é™…æµ‹è¯•**
   - ä½¿ç”¨çœŸå® LLM æµ‹è¯•
   - éªŒè¯å„ç§å·¥å…·åœºæ™¯
   - è·¨å¹³å°æµ‹è¯•

## ğŸ“Š ç»Ÿè®¡

- **ä»£ç å¢é‡**: ~400 è¡Œ
- **ä¿®æ”¹æ–‡ä»¶**: 4 ä¸ª
- **æ–°å¢æ–‡ä»¶**: 1 ä¸ª
- **ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡
- **æ¶æ„å®Œæ•´æ€§**: âœ… å®Œæ•´å®ç°

## ğŸ‰ æ€»ç»“

Phase 2 å·²å®Œå…¨å®ç°ï¼æ ¸å¿ƒçš„ Function Calling åŸºç¡€è®¾æ–½å·²ç»å°±ç»ªï¼š

âœ… **ç±»å‹ç³»ç»Ÿ** - æ”¯æŒå·¥å…·æ¶ˆæ¯  
âœ… **Provider å±‚** - OpenAI å…¼å®¹å®ç°  
âœ… **LLMClient** - å·¥å…·è°ƒç”¨å¾ªç¯  
âœ… **æµ‹è¯•è„šæœ¬** - éªŒè¯æµç¨‹  

ä¸‹ä¸€æ­¥åªéœ€è¦å°†è¿™å¥—ç³»ç»Ÿé›†æˆåˆ°ä¸» UI åº”ç”¨ä¸­ï¼Œç”¨æˆ·å°±èƒ½çœŸæ­£ä½¿ç”¨å·¥å…·åŠŸèƒ½äº†ï¼
