# 测试指南：多轮对话修复

## 已修复的问题

### 问题描述
- 多轮对话模式在第一次回复后立即退出
- 没有显示告别消息
- 循环似乎只执行一次就跳到 finally 块

### 根本原因
1. **ora 的 StdinDiscarder 冲突**：ora spinner 会创建自己的 readline 接口，复用同一个 stdin。当 spinner 停止时，可能会影响我们的 readline 状态。
2. **readline 被意外关闭**：由于 ora 的干扰，我们的 readline 接口在第一次使用后被关闭。

### 解决方案
1. **替换 ora 为自定义 spinner**：使用简单的 `setInterval` 实现，不创建额外的 readline 接口
2. **添加 readline 恢复机制**：在每次 `getUserInput()` 调用时检查 readline 状态，如果关闭则自动重新创建
3. **添加调试日志**：方便追踪循环执行和 readline 状态

## 测试步骤

### 1. 测试多轮对话（交互模式）

```bash
npm start
```

**预期行为**：
1. 显示欢迎横幅
2. 显示 `You:` 提示
3. 输入第一条消息，例如："你好"
4. AI 显示 thinking spinner
5. AI 回复
6. **重要**：再次显示 `You:` 提示（而不是退出）
7. 继续输入更多消息进行测试
8. 输入 `exit` 或 `/exit` 退出
9. 显示告别消息："👋 感谢使用 Yellow Silk！"

**测试至少 3 轮对话**：
```
You: 你好
🤖 Ani: [回复]

You: 你叫什么名字？
🤖 Ani: [回复]

You: 今天天气怎么样？
🤖 Ani: [回复]

You: exit
👋 感谢使用 Yellow Silk！
```

### 2. 测试单次提示模式（确保没有破坏）

```bash
npm start -p "你好，请介绍一下自己"
```

**预期行为**：
1. 不显示欢迎横幅
2. 显示问题和 spinner
3. 显示 AI 回复
4. 立即退出（没有告别消息）

### 3. 测试命令

在交互模式下测试以下命令：

```bash
npm start
```

```
You: /help       # 应显示帮助信息，然后继续
You: /model      # 应显示模型信息，然后继续
You: /config     # 应显示配置信息，然后继续
You: /clear      # 应清空对话历史，然后继续
You: /exit       # 应退出并显示告别消息
```

### 4. 调试日志

如果遇到问题，查看调试输出：
- `[DEBUG] === 循环迭代 #N ===` - 循环计数
- `[WARN] readline 已关闭，正在重新创建...` - readline 恢复机制触发（不应该在正常交互模式下出现）
- `[DEBUG] 收到输入: "..."` - 确认输入被接收
- `[DEBUG] 迭代 #N 完成` - 确认迭代完成
- `[DEBUG] 正常退出` - 确认是正常退出而非异常

### 5. 预期的调试输出示例

**正常的多轮对话**：
```
🚀 正在启动 Yellow Silk TUI...

[DEBUG] === 循环迭代 #1 ===
You: 你好
[DEBUG] 收到输入: "你好"

👤 你：
你好

⠋ 思考中...

🤖 Ani：
你好！我是 Ani...

[DEBUG] 迭代 #1 完成
[DEBUG] === 循环迭代 #2 ===
You: 再见
[DEBUG] 收到输入: "再见"
...
```

## 已知限制

1. **管道输入测试失败**：使用 `echo "消息" | npm start` 或 heredoc 测试时，stdin 会在管道结束时关闭，导致 readline 失效。这是正常行为，不影响实际使用。

2. **readline 恢复机制**：虽然我们添加了自动恢复机制，但在正常交互模式下不应该需要它。如果看到 "[WARN] readline 已关闭，正在重新创建..." 警告，说明仍然存在问题。

## 成功标志

✅ 可以进行多轮对话（至少 3 轮）
✅ 每轮对话后都显示新的 `You:` 提示
✅ 使用 `exit` 或 `/exit` 退出时显示告别消息
✅ 不会在第一次回复后意外退出
✅ 所有命令正常工作
✅ spinner 正常显示和停止

## 失败标志

❌ 第一次回复后立即退出
❌ 循环只执行一次
❌ 没有显示告别消息
❌ 看到 "readline was closed" 错误（在交互模式下）
❌ 在正常使用中频繁看到 readline 重新创建警告

## 如果测试失败

1. 检查是否在真实的终端中运行（不是通过管道或脚本）
2. 确保 LM Studio 正在运行并且模型已加载
3. 检查调试日志，看循环是否真的执行了多次
4. 查看是否有异常被抛出
5. 提供完整的调试输出以便进一步分析

## 性能验证

- spinner 动画应该流畅（80ms 每帧）
- 输入响应应该即时（没有延迟）
- 不应该有额外的 readline 警告或错误
